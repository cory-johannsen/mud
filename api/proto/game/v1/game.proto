syntax = "proto3";

package game.v1;

option go_package = "github.com/cory-johannsen/mud/internal/gameserver/gamev1";

// GameService provides bidirectional streaming between the Telnet frontend
// and the Pitaya-powered game backend.
service GameService {
  // Session establishes a bidirectional stream for a single player session.
  // The client sends commands; the server sends events.
  rpc Session(stream ClientMessage) returns (stream ServerEvent);
}

// ClientMessage wraps all client-to-server commands.
message ClientMessage {
  string request_id = 1;
  oneof payload {
    JoinWorldRequest join_world = 2;
    MoveRequest move = 3;
    LookRequest look = 4;
    SayRequest say = 5;
    EmoteRequest emote = 6;
    WhoRequest who = 7;
    ExitsRequest exits = 8;
    QuitRequest quit = 9;
    ExamineRequest examine = 10;
    AttackRequest attack = 11;
    FleeRequest   flee   = 12;
    PassRequest   pass   = 13;
    StrikeRequest strike = 14;
    StatusRequest status = 15;
    EquipRequest equip = 16;
    ReloadRequest reload = 17;
    FireBurstRequest fire_burst = 18;
    FireAutomaticRequest fire_automatic = 19;
    ThrowRequest throw = 20;
    InventoryRequest inventory_req = 21;
    GetItemRequest get_item = 22;
    DropItemRequest drop_item = 23;
    BalanceRequest balance = 24;
    SetRoleRequest set_role = 25;
    TeleportRequest teleport = 26;
    LoadoutRequest   loadout   = 27;
    UnequipRequest   unequip   = 28;
    EquipmentRequest equipment = 29;
  }
}

// ServerEvent wraps all server-to-client events.
message ServerEvent {
  string request_id = 1;
  oneof payload {
    RoomView room_view = 2;
    MessageEvent message = 3;
    RoomEvent room_event = 4;
    PlayerList player_list = 5;
    ExitList exit_list = 6;
    ErrorEvent error = 7;
    Disconnected disconnected = 8;
    CharacterInfo character_info = 9;
    NpcView npc_view = 10;
    CombatEvent combat_event = 11;
    RoundStartEvent round_start = 12;
    RoundEndEvent   round_end   = 13;
    ConditionEvent  condition_event = 14;
    InventoryView inventory_view = 15;
  }
}

// JoinWorldRequest is sent by the client to enter the game world after authentication.
message JoinWorldRequest {
  string uid = 1;
  string username = 2;
  int64  character_id   = 3;
  string character_name = 4;
  int32  current_hp     = 5;
  string location       = 6;
  string role           = 7;
  string region_display = 8;
  string class          = 9;
  int32  level          = 10;
}

// MoveRequest asks the server to move the player in the given direction.
message MoveRequest {
  string direction = 1;
}

// LookRequest asks the server for the current room description.
message LookRequest {}

// SayRequest sends a chat message to all players in the same room.
message SayRequest {
  string message = 1;
}

// EmoteRequest sends an emote action to all players in the same room.
message EmoteRequest {
  string action = 1;
}

// WhoRequest asks for the list of players in the current room.
message WhoRequest {}

// ExitsRequest asks for the list of exits from the current room.
message ExitsRequest {}

// QuitRequest signals the client wants to disconnect.
message QuitRequest {}

// RoomView describes the player's current room.
message RoomView {
  string room_id = 1;
  string title = 2;
  string description = 3;
  repeated ExitInfo exits = 4;
  repeated string players = 5;
  repeated NpcInfo npcs = 6;
  repeated ConditionInfo active_conditions = 7;
  repeated FloorItem floor_items = 8;
}

// ExitInfo describes a single exit from a room.
message ExitInfo {
  string direction = 1;
  string target_room_id = 2;
  bool locked = 3;
  bool hidden = 4;
  string target_title = 5;
}

// MessageEvent delivers a chat message or emote from another player.
message MessageEvent {
  string sender = 1;
  string content = 2;
  MessageType type = 3;
}

// MessageType distinguishes between say and emote messages.
enum MessageType {
  MESSAGE_TYPE_UNSPECIFIED = 0;
  MESSAGE_TYPE_SAY = 1;
  MESSAGE_TYPE_EMOTE = 2;
}

// RoomEvent notifies about player arrivals and departures.
message RoomEvent {
  string player = 1;
  RoomEventType type = 2;
  string direction = 3;
}

// RoomEventType distinguishes arrival from departure.
enum RoomEventType {
  ROOM_EVENT_TYPE_UNSPECIFIED = 0;
  ROOM_EVENT_TYPE_ARRIVE = 1;
  ROOM_EVENT_TYPE_DEPART = 2;
}

// PlayerList contains the players in the current room.
message PlayerList {
  string room_title = 1;
  repeated string players = 2;
}

// ExitList contains the exits from the current room.
message ExitList {
  repeated ExitInfo exits = 1;
}

// ErrorEvent delivers an error message to the client.
message ErrorEvent {
  string message = 1;
}

// Disconnected signals the server is closing the session.
message Disconnected {
  string reason = 1;
}

// CharacterInfo is sent to the client on session join to display character stats.
message CharacterInfo {
  int64  character_id  = 1;
  string name          = 2;
  string region        = 3;
  string class         = 4;
  int32  level         = 5;
  int32  experience    = 6;
  int32  max_hp        = 7;
  int32  current_hp    = 8;
  int32  brutality     = 9;
  int32  quickness     = 10;
  int32  grit          = 11;
  int32  reasoning     = 12;
  int32  savvy         = 13;
  int32  flair         = 14;
}

// NpcInfo summarises an NPC visible in the room.
message NpcInfo {
  string instance_id = 1;
  string name        = 2;
}

// ExamineRequest asks the server for detail on a named target.
message ExamineRequest {
  string target = 1;
}

// NpcView delivers detailed NPC information in response to examine.
message NpcView {
  string instance_id        = 1;
  string name               = 2;
  string description        = 3;
  string health_description = 4;
  int32  level              = 5;
}

// AttackRequest asks the server to attack a named target.
message AttackRequest {
  string target = 1;
}

// FleeRequest asks the server to attempt to flee combat.
message FleeRequest {}

// PassRequest forfeits the player's remaining action points for the current round.
message PassRequest {}

// StrikeRequest queues a 2-AP full attack routine (two attacks with MAP) against a target.
message StrikeRequest {
  string target = 1;
}

// EquipRequest asks the server to equip a weapon in the specified slot.
message EquipRequest {
  string weapon_id = 1;
  string slot = 2; // "primary", "secondary", "holster"
}

// ReloadRequest asks the server to reload the specified weapon, or the primary slot if empty.
message ReloadRequest {
  string weapon_id = 1; // empty = reload primary slot
}

// FireBurstRequest asks the server to fire a burst at the specified target.
message FireBurstRequest {
  string target = 1;
  string weapon_id = 2;
}

// FireAutomaticRequest asks the server to fire automatically at the specified target.
message FireAutomaticRequest {
  string target = 1;
  string weapon_id = 2;
}

// ThrowRequest asks the server to throw an explosive.
message ThrowRequest {
  string explosive_id = 1;
}

// InventoryRequest asks the server for the player's backpack contents and currency.
message InventoryRequest {}

// GetItemRequest asks the server to pick up an item from the room floor.
message GetItemRequest {
  string target = 1; // item name or "all"
}

// DropItemRequest asks the server to drop an item from the backpack.
message DropItemRequest {
  string target = 1; // item name
}

// BalanceRequest asks the server for the player's currency.
message BalanceRequest {}

// SetRoleRequest asks the server to change a player's privilege level.
message SetRoleRequest {
  string target_username = 1;
  string role = 2;
}

// LoadoutRequest displays or swaps the player's weapon presets.
// If arg is empty, the server returns the current loadout display.
message LoadoutRequest {
  string arg = 1;
}

// UnequipRequest removes the item in the named slot and returns it to the backpack.
message UnequipRequest {
  string slot = 1;
}

// EquipmentRequest asks the server to display all equipped items.
message EquipmentRequest {}

// TeleportRequest asks the server to teleport a player to a specific room.
message TeleportRequest {
  string target_character = 1;
  string room_id = 2;
}

// FloorItem describes an item on the room floor.
message FloorItem {
  string instance_id = 1;
  string name = 2;
  int32 quantity = 3;
}

// InventoryItem describes an item in the player's backpack.
message InventoryItem {
  string instance_id = 1;
  string name = 2;
  string kind = 3;
  int32 quantity = 4;
  double weight = 5;
}

// InventoryView shows the player's backpack and currency.
message InventoryView {
  repeated InventoryItem items = 1;
  int32 used_slots = 2;
  int32 max_slots = 3;
  double total_weight = 4;
  double max_weight = 5;
  string currency = 6;
  int32 total_rounds = 7;
}

// RoundStartEvent is broadcast to all combatants when a new round begins.
message RoundStartEvent {
  int32           round            = 1;
  int32           actions_per_turn = 2;
  int32           duration_ms      = 3;
  repeated string turn_order       = 4;
}

// RoundEndEvent is broadcast when a round's actions have resolved.
message RoundEndEvent {
  int32 round = 1;
}

// CombatEvent delivers combat narration to all players in the room.
message CombatEvent {
  CombatEventType type    = 1;
  string attacker         = 2;
  string target           = 3;
  int32  attack_roll      = 4;
  int32  attack_total     = 5;
  string outcome          = 6;
  int32  damage           = 7;
  int32  target_hp        = 8;
  string narrative        = 9;
  string weapon_name      = 10;
}

// CombatEventType distinguishes combat narration events.
enum CombatEventType {
  COMBAT_EVENT_TYPE_UNSPECIFIED  = 0;
  COMBAT_EVENT_TYPE_INITIATIVE   = 1;
  COMBAT_EVENT_TYPE_ATTACK       = 2;
  COMBAT_EVENT_TYPE_DEATH        = 3;
  COMBAT_EVENT_TYPE_FLEE         = 4;
  COMBAT_EVENT_TYPE_END          = 5;
  COMBAT_EVENT_TYPE_CONDITION    = 6;
  COMBAT_EVENT_TYPE_RELOAD       = 7;
  COMBAT_EVENT_TYPE_THROW        = 8;
}

// StatusRequest asks the server to return the player's active conditions.
message StatusRequest {}

// ConditionEvent reports a condition being applied to or removed from an entity.
message ConditionEvent {
  string target_uid     = 1;
  string target_name    = 2;
  string condition_id   = 3;
  string condition_name = 4;
  int32  stacks         = 5;
  bool   applied        = 6;  // true = applied/advanced, false = removed/expired
}

// ConditionInfo describes one active condition on a combatant.
message ConditionInfo {
  string id                 = 1;
  string name               = 2;
  int32  stacks             = 3;
  int32  duration_remaining = 4;  // -1 = permanent or until_save
}
